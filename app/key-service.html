<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>å…¬é–‹IDã¨ç§˜å¯†éµç”Ÿæˆãƒ„ãƒ¼ãƒ«</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-sha3@0.8.0/build/sha3.min.js"></script>
</head>
<body>
  <h1>ğŸ” å…¬é–‹IDã¨ç§˜å¯†éµã‚’ç”Ÿæˆ</h1>
  <button id="generate">ç”Ÿæˆã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
  <p id="status"></p>

  <script>
    async function blake3(input) {
      const encoder = new TextEncoder();
      const data = input instanceof Uint8Array ? input : encoder.encode(input);
      const digest = await crypto.subtle.digest("SHA-256", data); // ä»®ã®BLAKE3ä»£ç”¨ï¼ˆæœ¬ç‰©ã¯WASMæ¨å¥¨ï¼‰
      return new Uint8Array(digest);
    }

    document.getElementById("generate").addEventListener("click", async () => {
      const status = document.getElementById("status");
      status.textContent = "ç”Ÿæˆä¸­...";

      // 1. ç§˜å¯†ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆ256ãƒã‚¤ãƒˆ = 2048bitï¼‰
      const secret = new Uint8Array(256);
      crypto.getRandomValues(secret);

      // 2. ãƒãƒƒã‚·ãƒ¥ç”Ÿæˆ
      const sha3 = sha3_512.arrayBuffer(secret);         // A
      const blake = await blake3(secret);                // Bï¼ˆä»®ï¼‰
      const hidden = sha3_512.arrayBuffer(new Uint8Array(sha3)); // H
      const uid_sha = new Uint8Array(sha3_512.arrayBuffer(new Uint8Array(hidden))).slice(0, 16);
      const uid_blake = blake.slice(0, 16);
      const final_uid = [...uid_sha, ...uid_blake];

      // 3. éµç”Ÿæˆï¼ˆEd25519ï¼‰
      const keypair = nacl.sign.keyPair.fromSeed(secret.slice(0, 32)); // Ed25519ã¯32ãƒã‚¤ãƒˆseed
      const secretKey = keypair.secretKey;
      const publicKey = keypair.publicKey;

      // 4. ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
      const uidHex = final_uid.map(b => b.toString(16).padStart(2, '0')).join('');
      const idTxt = `uid=${uidHex}\nalg_id=sha3-512+blake3\nalg_sig=ed25519\n`;

      const zip = new JSZip();
      zip.file("id.txt", idTxt);
      zip.file("secret-key", secretKey);

      const blob = await zip.generateAsync({ type: "blob" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `ukey-${uidHex.slice(0, 8)}.zip`;
      link.click();

      status.textContent = "âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼";
    });
  </script>
</body>
</html>
